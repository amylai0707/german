<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·æ–‡å–®å­—æœ¬ ğŸ“š</title>
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc }
        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      // Firebase è¨­å®š
      const firebaseConfig = {
        apiKey:            "AIzaSyDYNJUXegjiGRRITWc9esEZkvZ0N1djUzk",
        authDomain:        "german-ac299.firebaseapp.com",
        projectId:         "german-ac299",
        storageBucket:     "german-ac299.firebasestorage.app",
        messagingSenderId: "748368675760",
        appId:             "1:748368675760:web:e95aa3d308f8a66044cc75"
      };

      const app  = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db   = getFirestore(app);

      // æ›åˆ° window è®“å…¶ä»–å‡½å¼å­˜å–
      window._auth     = auth;
      window._db       = db;
      window._provider = new GoogleAuthProvider();
      window._doc      = doc;
      window._getDoc   = getDoc;
      window._setDoc   = setDoc;
      window._signInWithPopup = signInWithPopup;
      window._signOut  = signOut;

      // ç›£è½ç™»å…¥ç‹€æ…‹
      onAuthStateChanged(auth, user => {
        if (user) {
          window._currentUser = user;
          window.onUserSignedIn(user);
        } else {
          window._currentUser = null;
          window.onUserSignedOut();
        }
      });
    </script>
    <style>
        /* â”€â”€ Login Screen â”€â”€ */
        #login-screen {
            position: fixed; inset: 0; z-index: 200;
            background: linear-gradient(135deg, #c89f7e 0%, #8b7355 100%);
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .login-card {
            background: white; border-radius: 24px; padding: 48px 40px;
            text-align: center; box-shadow: 0 24px 64px rgba(0,0,0,0.3);
            max-width: 380px; width: 100%;
        }
        .login-icon { font-size: 56px; margin-bottom: 14px; }
        .login-title { font-size: 22px; font-weight: 800; color: #8b6f47; margin-bottom: 8px; }
        .login-sub { font-size: 14px; color: #999; margin-bottom: 32px; line-height: 1.6; }
        .google-btn {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 14px 20px; border-radius: 10px;
            background: white; color: #444; border: 2px solid #e0e0e0;
            font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .google-btn:hover { border-color: #a0826d; background: #fff8f3; box-shadow: 0 4px 16px rgba(160,130,109,0.2); }
        .google-logo { width: 20px; height: 20px; }
        .login-note { font-size: 11px; color: #ccc; margin-top: 20px; line-height: 1.6; }

        /* â”€â”€ User bar â”€â”€ */
        .user-bar {
            display: flex; align-items: center; gap: 10px;
            background: #f5ebe0; border-radius: 10px; padding: 10px 14px;
            margin-bottom: 16px;
        }
        .user-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            object-fit: cover; border: 2px solid #d4a574;
        }
        .user-avatar-placeholder {
            width: 32px; height: 32px; border-radius: 50%;
            background: #d4a574; color: white; display: flex;
            align-items: center; justify-content: center; font-size: 14px; font-weight: 700;
        }
        .user-name { font-size: 13px; font-weight: 600; color: #8b6f47; flex: 1; }
        .user-email { font-size: 11px; color: #999; }
        .signout-btn { width: auto; padding: 6px 14px; font-size: 12px; background: white; color: #a0826d; border: 1.5px solid #d4a574; border-radius: 8px; }
        .signout-btn:hover { background: #f5ebe0; }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #c89f7e 0%, #8b7355 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* â”€â”€ Loading screen â”€â”€ */
        #loading-screen {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #c89f7e 0%, #8b7355 100%);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 999; gap: 16px;
        }
        .loading-card {
            background: white; border-radius: 20px; padding: 40px 50px;
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .loading-icon { font-size: 48px; margin-bottom: 12px; }
        .loading-title { font-size: 20px; font-weight: 700; color: #8b6f47; margin-bottom: 6px; }
        .loading-sub { font-size: 13px; color: #999; margin-bottom: 20px; }
        /* Export/Import section */
        .backup-section { background:#f0f7ff; border:1px solid #b3d4f5; border-radius:10px; padding:14px 16px; margin-bottom:16px; }
        .backup-section h4 { color:#1565c0; font-size:13px; margin-bottom:10px; }
        .backup-btns { display:flex; gap:8px; flex-wrap:wrap; }
        .backup-btn { width:auto; flex:1; min-width:120px; padding:8px 14px; font-size:13px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
        .backup-btn.export { background:#1976d2; color:white; }
        .backup-btn.export:hover { background:#1565c0; }
        .backup-btn.import { background:white; color:#1976d2; border:2px solid #1976d2; }
        .backup-btn.import:hover { background:#e3f2fd; }
        .loading-bar { width: 200px; height: 5px; background: #f0e0d0; border-radius: 5px; overflow: hidden; }
        .loading-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #a0826d, #d4a574);
            border-radius: 5px;
            animation: loadpulse 1.5s ease-in-out infinite;
        }
        @keyframes loadpulse {
            0% { width: 0%; } 50% { width: 70%; } 100% { width: 100%; }
        }

        /* â”€â”€ Sync indicator â”€â”€ */
        .sync-bar {
            display: flex; align-items: center; gap: 8px;
            background: #e8f5e9; border: 1px solid #a5d6a7;
            border-radius: 8px; padding: 8px 14px; margin-bottom: 16px;
            font-size: 13px; color: #388e3c;
            transition: all 0.3s;
        }
        .sync-bar.syncing { background: #fff8e7; border-color: #ffe082; color: #f57f17; }
        .sync-bar.error   { background: #ffebee; border-color: #ef9a9a; color: #c62828; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #66bb6a; flex-shrink: 0; }
        .sync-bar.syncing .sync-dot { background: #ffb300; animation: blink 0.8s infinite; }
        .sync-bar.error   .sync-dot { background: #ef5350; }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

        .container {
            max-width: 680px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 { color: #8b6f47; margin-bottom: 6px; font-size: 28px; }
        .subtitle { color: #666; margin-bottom: 16px; font-size: 14px; }

        .stats-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-box {
            flex: 1; min-width: 100px;
            background: #f5ebe0; border-radius: 10px; padding: 12px 14px; text-align: center;
        }
        .stat-num { font-size: 22px; font-weight: 700; color: #a0826d; }
        .stat-label { font-size: 11px; color: #999; margin-top: 2px; }

        .main-tabs {
            display: flex; gap: 6px; margin-bottom: 20px;
            background: #f5ebe0; padding: 5px; border-radius: 10px;
        }
        .main-tab {
            flex: 1; padding: 9px 6px; border: none; border-radius: 7px;
            background: transparent; color: #a0826d; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .main-tab.active { background: #a0826d; color: white; }
        .main-tab:hover:not(.active) { background: #ead9c8; }

        .notification-toggle {
            background: #f5ebe0; padding: 12px 15px; border-radius: 8px;
            margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;
        }
        .toggle-btn { width: auto; padding: 7px 16px; font-size: 13px; }

        .reminder {
            background: #fff8e7; padding: 12px 15px; border-radius: 8px;
            margin-bottom: 16px; border-left: 4px solid #d4a574; display: none;
        }

        /* â”€â”€ Category dropdown â”€â”€ */
        .cat-dropdown-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
        }
        .cat-label { font-size: 13px; color: #8b6f47; font-weight: 600; white-space: nowrap; }
        .cat-select {
            flex: 1; padding: 9px 14px; border: 2px solid #d4a574; border-radius: 10px;
            font-size: 14px; color: #8b6f47; background: white; cursor: pointer;
            font-family: inherit; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23a0826d' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 12px center;
            padding-right: 32px; transition: border-color 0.2s;
        }
        .cat-select:focus { outline: none; border-color: #a0826d; }

        /* â”€â”€ Note modal â”€â”€ */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.45);
            display: flex; align-items: center; justify-content: center;
            z-index: 500; padding: 20px; opacity: 0; pointer-events: none;
            transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: all; }
        .modal-box {
            background: white; border-radius: 18px; padding: 28px 28px 24px;
            width: 100%; max-width: 460px; box-shadow: 0 16px 48px rgba(0,0,0,0.25);
            transform: translateY(16px); transition: transform 0.2s;
        }
        .modal-overlay.show .modal-box { transform: translateY(0); }
        .modal-word { font-size: 22px; font-weight: 800; color: #8b6f47; margin-bottom: 4px; }
        .modal-zh { font-size: 14px; color: #999; margin-bottom: 20px; }
        .modal-label { font-size: 12px; font-weight: 700; color: #a0826d; letter-spacing: 0.5px; margin-bottom: 6px; text-transform: uppercase; }
        .modal-textarea {
            width: 100%; border: 2px solid #e8d5c0; border-radius: 10px;
            padding: 10px 12px; font-size: 14px; font-family: inherit;
            resize: vertical; min-height: 72px; transition: border-color 0.2s;
            margin-bottom: 14px; line-height: 1.5;
        }
        .modal-textarea:focus { outline: none; border-color: #a0826d; }
        .modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-save { background: #a0826d; color: white; border: none; padding: 10px 24px; border-radius: 9px; font-size: 14px; font-weight: 600; cursor: pointer; width: auto; }
        .modal-save:hover { background: #8b6f47; }
        .modal-cancel { background: white; color: #999; border: 2px solid #e0e0e0; padding: 10px 18px; border-radius: 9px; font-size: 14px; cursor: pointer; width: auto; }
        .modal-cancel:hover { border-color: #ccc; color: #666; }
        .modal-clear { background: white; color: #ff4757; border: 2px solid #ff4757; padding: 10px 14px; border-radius: 9px; font-size: 13px; cursor: pointer; width: auto; margin-right: auto; }
        .modal-clear:hover { background: #ffebee; }

        /* note display on card */
        .card-note { font-size: 12px; color: #a0826d; font-style: italic; margin-top: 8px; max-width: 280px; line-height: 1.5; text-align:center; }
        .card-note-ex { font-size: 12px; color: #888; margin-top: 4px; max-width: 280px; line-height: 1.5; text-align:center; }
        .edit-note-btn {
            position: absolute; bottom: 12px; right: 14px;
            background: rgba(160,130,109,0.1); border: 1px solid #d4a574;
            color: #a0826d; font-size: 11px; padding: 4px 10px;
            border-radius: 20px; cursor: pointer; width: auto; transition: all 0.2s;
        }
        .edit-note-btn:hover { background: #d4a574; color: white; }
        .note-dot {
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            font-size: 11px; color: #a0826d; background: rgba(160,130,109,0.1);
            padding: 2px 10px; border-radius: 20px; border: 1px solid #e8d5c0;
        }

        /* word list note */
        .word-note { font-size: 12px; color: #a0826d; font-style: italic; margin-top: 4px; padding-left: 8px; border-left: 3px solid #e8d5c0; }
        .word-note-ex { font-size: 12px; color: #888; margin-top: 2px; padding-left: 8px; border-left: 3px solid #f0e4d4; }
        .word-item-btns { display: flex; gap: 6px; flex-shrink: 0; align-items: center; }
        .edit-btn { background: #f5ebe0; color: #8b6f47; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 13px; width: auto; }
        .edit-btn:hover { background: #d4a574; color: white; }

        /* Flashcard */
        .flash-counter { text-align: center; color: #999; font-size: 13px; margin-bottom: 10px; }
        .flash-progress { height: 5px; background: #f0e0d0; border-radius: 5px; margin-bottom: 18px; overflow: hidden; }
        .flash-progress-fill { height: 100%; background: linear-gradient(90deg,#a0826d,#d4a574); border-radius:5px; transition:width 0.3s; }

        .card-stage { perspective: 1000px; margin-bottom: 18px; }
        .flashcard {
            width: 100%; height: 220px; cursor: pointer;
            transform-style: preserve-3d; transition: transform 0.5s cubic-bezier(.4,0,.2,1); position: relative;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; inset: 0; backface-visibility: hidden;
            border-radius: 16px; padding: 28px 30px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; border: 2px solid #e8d5c0;
        }
        .card-front { background: linear-gradient(145deg, #fff8f3, #f5ebe0); }
        .card-back  { background: linear-gradient(145deg, #fff3e0, #ffe0b2); transform: rotateY(180deg); }
        .card-top-row {
            position: absolute; top: 12px; left: 16px; right: 16px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-tag { font-size: 11px; color: #bbb; letter-spacing: 1px; text-transform: uppercase; }
        .fav-btn {
            background: none; border: none; font-size: 20px; cursor: pointer;
            transition: transform 0.2s; width: auto; padding: 0;
        }
        .fav-btn:hover { transform: scale(1.3); }
        .card-article { font-size: 14px; color: #a0826d; font-weight: 600; margin-bottom: 4px; }
        .card-de { font-size: clamp(1.4rem,5vw,2rem); font-weight: 700; color: #8b6f47; margin-bottom: 8px; }
        .card-cat { font-size: 11px; background: #d4a574; color: white; padding: 3px 10px; border-radius: 10px; }
        .card-hint { font-size: 12px; color: #bbb; margin-top: 10px; }
        .card-zh { font-size: clamp(1.1rem,4vw,1.5rem); font-weight: 700; color: #8b6f47; margin-bottom: 8px; }
        .card-source { font-size: 12px; color: #bbb; }

        .flash-nav { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 14px; }
        .nav-btn {
            width: 44px; height: 44px; border-radius: 50%; border: 2px solid #d4a574;
            background: white; color: #8b6f47; font-size: 18px; cursor: pointer; transition: all 0.2s;
        }
        .nav-btn:hover:not(:disabled) { background: #d4a574; color: white; }
        .nav-btn:disabled { opacity: 0.3; cursor: default; }
        .flash-actions { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
        .action-btn {
            padding: 8px 16px; border-radius: 8px; border: 1.5px solid #d4a574;
            background: white; color: #8b6f47; font-size: 13px; cursor: pointer; transition: all 0.2s;
        }
        .action-btn:hover { background: #d4a574; color: white; }
        .key-hint { text-align: center; font-size: 11px; color: #bbb; }

        /* Quiz */
        .quiz-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .quiz-score-display { font-size: 14px; color: #a0826d; font-weight: 600; }
        .quiz-prog { font-size: 13px; color: #999; }
        .quiz-q-card {
            background: linear-gradient(145deg,#fff8f3,#f5ebe0); border: 2px solid #e8d5c0;
            border-radius: 14px; padding: 30px 24px; text-align: center; margin-bottom: 18px;
        }
        .quiz-q-label { font-size: 11px; color: #bbb; letter-spacing: 1px; margin-bottom: 10px; }
        .quiz-q-word { font-size: clamp(1.5rem,5vw,2.2rem); font-weight: 700; color: #8b6f47; }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
        .quiz-opt {
            padding: 14px 16px; border-radius: 10px; border: 2px solid #e8d5c0;
            background: white; color: #555; font-size: 14px; cursor: pointer; text-align: left; transition: all 0.18s;
        }
        .quiz-opt:hover:not(:disabled) { border-color: #a0826d; color: #8b6f47; background: #fff8f3; }
        .quiz-opt.correct { background: #e8f5e9; border-color: #66bb6a; color: #2e7d32; }
        .quiz-opt.wrong   { background: #ffebee; border-color: #ef5350; color: #c62828; }
        .quiz-opt:disabled { cursor: default; }
        .quiz-result-box { text-align: center; padding: 50px 20px; }
        .quiz-big-score { font-size: 72px; font-weight: 900; color: #a0826d; line-height: 1; }
        .quiz-result-msg { font-size: 20px; font-weight: 700; color: #8b6f47; margin: 10px 0 6px; }
        .quiz-result-sub { color: #999; font-size: 14px; margin-bottom: 24px; }

        /* Favorites */
        .fav-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap: 10px; }
        .fav-card {
            background: #f5ebe0; border-radius: 10px; padding: 14px 16px;
            display: flex; justify-content: space-between; align-items: flex-start; border: 1.5px solid #e8d5c0;
        }
        .fav-de { font-weight: 700; color: #8b6f47; font-size: 15px; }
        .fav-zh { font-size: 13px; color: #666; margin-top: 3px; }
        .fav-tag { font-size: 10px; background: #d4a574; color: white; padding: 2px 8px; border-radius: 8px; margin-top: 5px; display: inline-block; }
        .unfav-btn { background: none; border: none; font-size: 16px; cursor: pointer; width: auto; padding: 0; }

        /* My Words */
        .add-word { background: #f5ebe0; padding: 18px; border-radius: 12px; margin-bottom: 20px; }
        .add-word h3 { color: #8b6f47; font-size: 15px; margin-bottom: 12px; }
        input {
            width: 100%; padding: 11px; margin-bottom: 8px;
            border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border 0.2s;
        }
        select {
            width: 100%; padding: 11px; margin-bottom: 8px;
            border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;
            background: white; cursor: pointer; transition: border 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: #a0826d; }
        button {
            width: 100%; padding: 11px; background: #a0826d; color: white;
            border: none; border-radius: 8px; font-size: 15px; cursor: pointer; transition: background 0.2s;
        }
        button:hover { background: #8b6f47; }

        .filter-section { background: #f5ebe0; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
        .filter-section h3 { color: #8b6f47; margin-bottom: 10px; font-size: 14px; }
        .filter-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-btn {
            width: auto; padding: 7px 14px; font-size: 13px;
            background: white; color: #8b6f47; border: 2px solid #d4a574;
        }
        .filter-btn:hover { background: #d4a574; color: white; }
        .filter-btn.active { background: #a0826d; color: white; border-color: #a0826d; }
        .export-section { display: flex; gap: 10px; margin-bottom: 16px; }
        .export-btn { width: auto; flex: 1; background: #7d9d65; }
        .export-btn:hover { background: #6a8556; }
        .word-list { margin-top: 10px; }
        .word-item {
            background: #f5ebe0; padding: 13px; margin-bottom: 8px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s;
        }
        .word-item:hover { transform: translateX(4px); }
        .word-content { flex-grow: 1; }
        .german { font-weight: bold; color: #8b6f47; font-size: 17px; margin-bottom: 4px; }
        .chinese { color: #666; font-size: 13px; }
        .sentence { color: #8b6f47; font-size: 12px; font-style: italic; margin-top: 4px; padding-left: 8px; border-left: 3px solid #d4a574; }
        .category { display: inline-block; background: #d4a574; color: white; padding: 2px 9px; border-radius: 10px; font-size: 11px; margin-top: 4px; }
        .delete-btn { background: #ff4757; color: white; border: none; padding: 7px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; width: auto; }
        .delete-btn:hover { background: #ee5a6f; }
        .bottom-stats { text-align: center; color: #999; margin-top: 16px; font-size: 13px; }

        .btn-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .btn-primary { background: #a0826d; color: white; border: none; padding: 11px 24px; border-radius: 9px; font-size: 14px; cursor: pointer; width: auto; }
        .btn-primary:hover { background: #8b6f47; }
        .btn-outline { background: white; color: #8b6f47; border: 2px solid #d4a574; padding: 11px 24px; border-radius: 9px; font-size: 14px; cursor: pointer; width: auto; }
        .btn-outline:hover { background: #f5ebe0; }

        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(80px);
            background: #8b6f47; color: white; padding: 10px 22px; border-radius: 10px;
            font-size: 14px; transition: transform 0.3s; z-index: 9999;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        @keyframes pop { 0%,100%{transform:scale(1)} 50%{transform:scale(1.25)} }
        .pop { animation: pop 0.3s ease; }
        .empty-state { text-align: center; padding: 50px 20px; color: #bbb; }
        .empty-state .big { font-size: 48px; margin-bottom: 12px; }

        @media (max-width: 480px) {
            .quiz-options { grid-template-columns: 1fr; }
            .stats-row { gap: 6px; }
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen">
    <div class="login-card">
        <div class="login-icon">ğŸ“š</div>
        <div class="login-title">å¾·æ–‡å–®å­—æœ¬</div>
        <div class="login-sub">ç™»å…¥å¾Œï¼Œä½ çš„å–®å­—ã€ç­†è¨˜ã€é€²åº¦<br>æœƒè‡ªå‹•åŒæ­¥åˆ°æ‰€æœ‰è£ç½® â˜ï¸</div>
        <button class="google-btn" onclick="signInWithGoogle()">
            <svg class="google-logo" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            ç”¨ Google å¸³è™Ÿç™»å…¥
        </button>
        <div class="login-note">ğŸ”’ åªå­˜å–ä½ è‡ªå·±çš„å–®å­—è³‡æ–™ï¼Œä¸æœƒè®€å–å…¶ä»– Google å…§å®¹</div>
    </div>
</div>

<!-- Loading Screen -->
<div id="loading-screen" style="display:none;">
    <div class="loading-card">
        <div class="loading-icon">â˜ï¸</div>
        <div class="loading-title">æ­£åœ¨åŒæ­¥è³‡æ–™â€¦</div>
        <div class="loading-sub">å¾é›²ç«¯è¼‰å…¥ä½ çš„å–®å­—æœ¬</div>
        <div class="loading-bar"><div class="loading-fill"></div></div>
    </div>
</div>

<div class="container" id="main-app" style="display:none;">
    <h1>ğŸ“š æˆ‘çš„å¾·æ–‡å–®å­—æœ¬</h1>
    <p class="subtitle">æ¯å¤©å­¸ä¸€é»ï¼Œå¾·æ–‡æœƒæ›´å¥½ï¼B1 å…¨ä¸»é¡Œæ”¶éŒ„ âœ¨</p>

    <!-- User bar -->
    <div class="user-bar" id="user-bar">
        <div id="user-avatar-wrap"></div>
        <div>
            <div class="user-name" id="user-name"></div>
            <div class="user-email" id="user-email"></div>
        </div>
        <div class="sync-bar" id="sync-bar" style="margin:0;padding:6px 10px;flex:1;justify-content:flex-end;">
            <div class="sync-dot"></div>
            <span id="sync-text" style="font-size:12px;">å·²åŒæ­¥</span>
        </div>
        <button class="signout-btn" onclick="doSignOut()">ç™»å‡º</button>
    </div>

    <div class="stats-row">
        <div class="stat-box"><div class="stat-num" id="s-total">0</div><div class="stat-label">ç¸½å–®å­—</div></div>
        <div class="stat-box"><div class="stat-num" id="s-learned">0</div><div class="stat-label">å·²è¤‡ç¿’</div></div>
        <div class="stat-box"><div class="stat-num" id="s-fav">0</div><div class="stat-label">æ”¶è—</div></div>
        <div class="stat-box"><div class="stat-num" id="s-acc">0%</div><div class="stat-label">æ¸¬é©—æº–ç¢ºç‡</div></div>
    </div>

    <!-- Main Tabs -->
    <div class="main-tabs">
        <button class="main-tab active" onclick="switchTab('flash')">ğŸƒ ç¿»å¡</button>
        <button class="main-tab" onclick="switchTab('quiz')">ğŸ¯ æ¸¬é©—</button>
        <button class="main-tab" onclick="switchTab('fav')">â¤ï¸ æ”¶è—</button>
        <button class="main-tab" onclick="switchTab('mywords')">âœï¸ æˆ‘çš„å–®å­—</button>
    </div>

    <div class="notification-toggle" id="notif-bar" style="display:none;">
        <span>ğŸ”” æ¯æ—¥æé†’</span>
        <button class="toggle-btn" id="notificationBtn" onclick="toggleNotification()">å•Ÿç”¨é€šçŸ¥</button>
    </div>
    <div id="reminderBox" class="reminder">
        â° ä»Šå¤©è©²è¤‡ç¿’å–®å­—äº†ï¼ä½ å·²ç¶“å­¸äº† <span id="todayCount">0</span> å€‹å–®å­—
    </div>

    <!-- Category dropdown -->
    <div class="cat-dropdown-row" id="cat-dropdown-row">
        <span class="cat-label">ğŸ“‚ ä¸»é¡Œ</span>
        <select class="cat-select" id="cat-select" onchange="selectB1Cat(this.value)">
            <option value="å…¨éƒ¨">ğŸ—‚ å…¨éƒ¨å–®å­—</option>
            <option value="äººç‰©é—œä¿‚">ğŸ‘¥ äººç‰©é—œä¿‚</option>
            <option value="æ—¥å¸¸ç”Ÿæ´»">ğŸ  æ—¥å¸¸ç”Ÿæ´»</option>
            <option value="æºé€šè¡¨é”">ğŸ—£ æºé€šè¡¨é”</option>
            <option value="å·¥ä½œè·æ¥­">ğŸ’¼ å·¥ä½œè·æ¥­</option>
            <option value="æ•™è‚²">ğŸ“ æ•™è‚²</option>
            <option value="å¥åº·">ğŸ¥ å¥åº·</option>
            <option value="ç¤¾æœƒæ”¿æ²»">ğŸŒ ç¤¾æœƒæ”¿æ²»</option>
            <option value="äº¤é€šæ—…è¡Œ">ğŸš— äº¤é€šæ—…è¡Œ</option>
            <option value="è³¼ç‰©é‡‘éŒ¢">ğŸ›’ è³¼ç‰©é‡‘éŒ¢</option>
            <option value="å¤©æ°£è‡ªç„¶">ğŸŒ¦ å¤©æ°£è‡ªç„¶</option>
            <option value="å¸¸ç”¨å‹•è©">âš¡ å¸¸ç”¨å‹•è©</option>
            <option value="å½¢å®¹è©å‰¯è©">âœ¨ å½¢å®¹è©å‰¯è©</option>
            <option value="â­ æˆ‘çš„å–®å­—">â­ æˆ‘çš„å–®å­—</option>
        </select>
    </div>

    <!-- Note edit modal -->
    <div class="modal-overlay" id="note-modal" onclick="closeNoteModal(event)">
        <div class="modal-box">
            <div class="modal-word" id="modal-word"></div>
            <div class="modal-zh" id="modal-zh"></div>
            <div class="modal-label">ğŸ“ å€‹äººç­†è¨˜</div>
            <textarea class="modal-textarea" id="modal-note" placeholder="å¯«ä¸‹ä½ çš„ç­†è¨˜ã€è¨˜æ†¶å£è¨£ã€è£œå……èªªæ˜â€¦"></textarea>
            <div class="modal-label">ğŸ’¬ æˆ‘çš„ä¾‹å¥</div>
            <textarea class="modal-textarea" id="modal-example" placeholder="ç”¨é€™å€‹å–®å­—é€ ä¸€å€‹å¥å­â€¦"></textarea>
            <div class="modal-btns">
                <button class="modal-clear" onclick="clearNote()">ğŸ—‘ æ¸…é™¤</button>
                <button class="modal-cancel" onclick="closeNoteModal()">å–æ¶ˆ</button>
                <button class="modal-save" onclick="saveNote()">âœ… å„²å­˜</button>
            </div>
        </div>
    </div>
<!-- Edit Word modalï¼ˆæ–°å¢ï¼‰ -->
<div class="modal-overlay" id="edit-word-modal" onclick="closeEditWordModal(event)">
  <div class="modal-box">
    <div class="modal-word">ğŸ›  ç·¨è¼¯æˆ‘çš„å–®å­—</div>
    <div class="modal-label">å¾·æ–‡</div>
    <input id="edit-de" class="modal-textarea" style="height:auto" placeholder="å¾·æ–‡å–®å­—">
    <div class="modal-label">ä¸­æ–‡</div>
    <input id="edit-zh" class="modal-textarea" style="height:auto" placeholder="ä¸­æ–‡æ„æ€">
    <div class="modal-label">ä¾‹å¥ï¼ˆé¸å¡«ï¼‰</div>
    <textarea id="edit-sentence" class="modal-textarea" placeholder="ä¾‹å¥â€¦"></textarea>
    <div class="modal-label">åˆ†é¡</div>
    <select id="edit-category" class="modal-textarea" style="height:auto">
      <option value="åè©">åè© (Nomen)</option>
      <option value="å‹•è©">å‹•è© (Verb)</option>
      <option value="å½¢å®¹è©">å½¢å®¹è© (Adjektiv)</option>
      <option value="å‰¯è©">å‰¯è© (Adverb)</option>
      <option value="ä»‹è©">ä»‹è© (PrÃ¤position)</option>
      <option value="ç‰‡èª">ç‰‡èª (Phrase)</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeEditWordModal()">å–æ¶ˆ</button>
      <button class="modal-save" onclick="saveEditedWord()">âœ… å„²å­˜</button>
    </div>
  </div>
</div>
    <!-- FLASHCARD -->
    <div id="view-flash">
        <div class="flash-counter" id="flash-counter"></div>
        <div class="flash-progress"><div class="flash-progress-fill" id="fp-fill"></div></div>
        <div class="card-stage">
            <div class="flashcard" id="flashcard" onclick="flipCard()">
                <div class="card-face card-front">
                    <div class="card-top-row">
                        <span class="card-tag">å¾·æ–‡</span>
                        <button class="fav-btn" id="fav-btn" onclick="event.stopPropagation();toggleFav()">ğŸ¤</button>
                    </div>
                    <div id="note-dot" class="note-dot" style="display:none">ğŸ“ æœ‰ç­†è¨˜</div>
                    <div class="card-article" id="c-article"></div>
                    <div class="card-de" id="c-de">è¼‰å…¥ä¸­â€¦</div>
                    <div class="card-cat" id="c-cat"></div>
                    <div class="card-hint">é»æ“ŠæŸ¥çœ‹ä¸­æ–‡ ğŸ‘†</div>
                    <button class="edit-note-btn" onclick="event.stopPropagation();openNoteModal()">âœï¸ ç­†è¨˜</button>
                </div>
                <div class="card-face card-back">
                    <div class="card-top-row"><span class="card-tag">ç¿»è­¯</span></div>
                    <div class="card-zh" id="c-zh"></div>
                    <div class="card-source" id="c-source"></div>
                    <div class="card-note" id="c-note" style="display:none"></div>
                    <div class="card-note-ex" id="c-note-ex" style="display:none"></div>
                </div>
            </div>
        </div>
        <div class="flash-nav">
            <button class="nav-btn" id="btn-prev" onclick="prevCard()">â†</button>
            <button class="action-btn" onclick="shuffleCards()">ğŸ”€ éš¨æ©Ÿ</button>
            <button class="nav-btn" id="btn-next" onclick="nextCard()">â†’</button>
        </div>
        <div class="key-hint">âŒ¨ï¸ ç©ºç™½éµç¿»å¡ Â· â† â†’ åˆ‡æ› Â· F æ”¶è—</div>
    </div>

    <!-- QUIZ -->
    <div id="view-quiz" style="display:none;">
        <div id="quiz-play">
            <div class="quiz-top">
                <span class="quiz-score-display" id="q-score">âœ… 0 / 0</span>
                <span class="quiz-prog" id="q-prog">ç¬¬ 1 é¡Œ</span>
            </div>
            <div class="quiz-q-card">
                <div class="quiz-q-label">é€™å€‹å¾·æ–‡å–®å­—çš„ä¸­æ–‡æ„æ€æ˜¯ï¼Ÿ</div>
                <div class="quiz-q-word" id="q-word"></div>
            </div>
            <div class="quiz-options" id="q-opts"></div>
        </div>
        <div id="quiz-done" style="display:none;">
            <div class="quiz-result-box">
                <div class="quiz-big-score" id="qr-pct"></div>
                <div class="quiz-result-msg" id="qr-msg"></div>
                <div class="quiz-result-sub" id="qr-sub"></div>
                <div class="btn-row">
                    <button class="btn-primary" onclick="startQuiz()">ğŸ”„ å†è©¦ä¸€æ¬¡</button>
                    <button class="btn-outline" onclick="switchTab('flash')">ğŸ“– å›å»è¤‡ç¿’</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FAVORITES -->
    <div id="view-fav" style="display:none;">
        <div id="fav-content"></div>
    </div>

    <!-- MY WORDS -->
    <div id="view-mywords" style="display:none;">
        <div class="add-word">
            <h3>â• æ–°å¢è‡ªè¨‚å–®å­—</h3>
            <input type="text" id="germanInput" placeholder="å¾·æ–‡å–®å­—ï¼ˆä¾‹å¦‚ï¼šHalloï¼‰" />
            <input type="text" id="chineseInput" placeholder="ä¸­æ–‡æ„æ€ï¼ˆä¾‹å¦‚ï¼šä½ å¥½ï¼‰" />
            <input type="text" id="sentenceInput" placeholder="é€ å¥ï¼ˆé¸å¡«ï¼‰" />
            <select id="categoryInput">
                <option value="åè©">ğŸ·ï¸ åè© (Nomen)</option>
                <option value="å‹•è©">âš¡ å‹•è© (Verb)</option>
                <option value="å½¢å®¹è©">âœ¨ å½¢å®¹è© (Adjektiv)</option>
                <option value="å‰¯è©">ğŸ”„ å‰¯è© (Adverb)</option>
                <option value="ä»‹è©">ğŸ”— ä»‹è© (PrÃ¤position)</option>
                <option value="ç‰‡èª">ğŸ’­ ç‰‡èª (Phrase)</option>
                <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
            </select>
            <button onclick="addWord()">â• æ–°å¢</button>
        </div>
        <div class="filter-section">
            <h3>ğŸ” ç¯©é¸æˆ‘çš„å–®å­—</h3>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterWords('å…¨éƒ¨',event)">å…¨éƒ¨</button>
                <button class="filter-btn" onclick="filterWords('åè©',event)">åè©</button>
                <button class="filter-btn" onclick="filterWords('å‹•è©',event)">å‹•è©</button>
                <button class="filter-btn" onclick="filterWords('å½¢å®¹è©',event)">å½¢å®¹è©</button>
                <button class="filter-btn" onclick="filterWords('å‰¯è©',event)">å‰¯è©</button>
                <button class="filter-btn" onclick="filterWords('ä»‹è©',event)">ä»‹è©</button>
                <button class="filter-btn" onclick="filterWords('ç‰‡èª',event)">ç‰‡èª</button>
            </div>
        </div>
        <div class="export-section">
            <button onclick="exportToPDF()" class="export-btn">ğŸ“„ åŒ¯å‡º PDF</button>
            <button onclick="exportToExcel()" class="export-btn">ğŸ“Š åŒ¯å‡º Excel</button>
        </div>
        <div class="word-list" id="wordList"></div>
        <div class="bottom-stats">æˆ‘çš„è‡ªè¨‚å–®å­—å…± <strong id="totalWords">0</strong> å€‹ ğŸ‰</div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  B1 VOCABULARY DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const B1_VOCAB = [
  {de:"der Bekannte",zh:"ç†Ÿäºº",cat:"äººç‰©é—œä¿‚",article:"der"},
  {de:"der Nachbar",zh:"é„°å±…ï¼ˆç”·ï¼‰",cat:"äººç‰©é—œä¿‚",article:"der"},
  {de:"die Nachbarin",zh:"é„°å±…ï¼ˆå¥³ï¼‰",cat:"äººç‰©é—œä¿‚",article:"die"},
  {de:"der Kollege",zh:"åŒäº‹ï¼ˆç”·ï¼‰",cat:"äººç‰©é—œä¿‚",article:"der"},
  {de:"die Kollegin",zh:"åŒäº‹ï¼ˆå¥³ï¼‰",cat:"äººç‰©é—œä¿‚",article:"die"},
  {de:"der Vorgesetzte",zh:"ä¸Šå¸",cat:"äººç‰©é—œä¿‚",article:"der"},
  {de:"das Mitglied",zh:"æˆå“¡",cat:"äººç‰©é—œä¿‚",article:"das"},
  {de:"die Generation",zh:"ä¸–ä»£",cat:"äººç‰©é—œä¿‚",article:"die"},
  {de:"der Zeuge",zh:"è­‰äººï¼ˆç”·ï¼‰",cat:"äººç‰©é—œä¿‚",article:"der"},
  {de:"die Zeugin",zh:"è­‰äººï¼ˆå¥³ï¼‰",cat:"äººç‰©é—œä¿‚",article:"die"},
  {de:"der Alltag",zh:"æ—¥å¸¸ç”Ÿæ´»",cat:"æ—¥å¸¸ç”Ÿæ´»",article:"der"},
  {de:"die Gewohnheit",zh:"ç¿’æ…£",cat:"æ—¥å¸¸ç”Ÿæ´»",article:"die"},
  {de:"die Pflicht",zh:"ç¾©å‹™ã€è·è²¬",cat:"æ—¥å¸¸ç”Ÿæ´»",article:"die"},
  {de:"die MÃ¶glichkeit",zh:"å¯èƒ½æ€§",cat:"æ—¥å¸¸ç”Ÿæ´»",article:"die"},
  {de:"die Gelegenheit",zh:"æ©Ÿæœƒ",cat:"æ—¥å¸¸ç”Ÿæ´»",article:"die"},
  {de:"der Termin",zh:"ç´„å®šã€é ç´„",cat:"æ—¥å¸¸ç”Ÿæ´»",article:"der"},
  {de:"die Veranstaltung",zh:"æ´»å‹•",cat:"æ—¥å¸¸ç”Ÿæ´»",article:"die"},
  {de:"der Aufwand",zh:"åŠªåŠ›ã€èŠ±è²»",cat:"æ—¥å¸¸ç”Ÿæ´»",article:"der"},
  {de:"der Haushalt",zh:"å®¶å‹™ã€å®¶åº­",cat:"æ—¥å¸¸ç”Ÿæ´»",article:"der"},
  {de:"die Unterkunft",zh:"ä½æ‰€ã€ä½å®¿",cat:"æ—¥å¸¸ç”Ÿæ´»",article:"die"},
  {de:"erklÃ¤ren",zh:"è§£é‡‹",cat:"æºé€šè¡¨é”",article:""},
  {de:"berichten",zh:"å ±å‘Šã€å ±å°",cat:"æºé€šè¡¨é”",article:""},
  {de:"beschreiben",zh:"æè¿°",cat:"æºé€šè¡¨é”",article:""},
  {de:"behaupten",zh:"ä¸»å¼µã€è²ç¨±",cat:"æºé€šè¡¨é”",article:""},
  {de:"vorschlagen",zh:"å»ºè­°",cat:"æºé€šè¡¨é”",article:""},
  {de:"ablehnen",zh:"æ‹’çµ•",cat:"æºé€šè¡¨é”",article:""},
  {de:"zustimmen",zh:"åŒæ„",cat:"æºé€šè¡¨é”",article:""},
  {de:"kritisieren",zh:"æ‰¹è©•",cat:"æºé€šè¡¨é”",article:""},
  {de:"sich beschweren",zh:"æŠ±æ€¨",cat:"æºé€šè¡¨é”",article:""},
  {de:"Ã¼berzeugen",zh:"èªªæœ",cat:"æºé€šè¡¨é”",article:""},
  {de:"erwÃ¤hnen",zh:"æåŠ",cat:"æºé€šè¡¨é”",article:""},
  {de:"mitteilen",zh:"é€šçŸ¥ã€å‘ŠçŸ¥",cat:"æºé€šè¡¨é”",article:""},
  {de:"die Bewerbung",zh:"ç”³è«‹ã€æ‡‰å¾µ",cat:"å·¥ä½œè·æ¥­",article:"die"},
  {de:"das VorstellungsgesprÃ¤ch",zh:"é¢è©¦",cat:"å·¥ä½œè·æ¥­",article:"das"},
  {de:"die Stelle",zh:"è·ä½",cat:"å·¥ä½œè·æ¥­",article:"die"},
  {de:"die Erfahrung",zh:"ç¶“é©—",cat:"å·¥ä½œè·æ¥­",article:"die"},
  {de:"die Ausbildung",zh:"è·æ¥­è¨“ç·´",cat:"å·¥ä½œè·æ¥­",article:"die"},
  {de:"die FÃ¤higkeit",zh:"èƒ½åŠ›",cat:"å·¥ä½œè·æ¥­",article:"die"},
  {de:"der Lebenslauf",zh:"å±¥æ­·",cat:"å·¥ä½œè·æ¥­",article:"der"},
  {de:"die KÃ¼ndigung",zh:"è§£é›‡ã€è¾­è·",cat:"å·¥ä½œè·æ¥­",article:"die"},
  {de:"der Vertrag",zh:"åˆç´„",cat:"å·¥ä½œè·æ¥­",article:"der"},
  {de:"das Gehalt",zh:"è–ªè³‡",cat:"å·¥ä½œè·æ¥­",article:"das"},
  {de:"der Urlaub",zh:"ä¼‘å‡",cat:"å·¥ä½œè·æ¥­",article:"der"},
  {de:"die Ãœberstunde",zh:"åŠ ç­",cat:"å·¥ä½œè·æ¥­",article:"die"},
  {de:"das Studium",zh:"å¤§å­¸å­¸ç¿’",cat:"æ•™è‚²",article:"das"},
  {de:"der Abschluss",zh:"ç•¢æ¥­ã€çµæ¥­",cat:"æ•™è‚²",article:"der"},
  {de:"die Note",zh:"æˆç¸¾",cat:"æ•™è‚²",article:"die"},
  {de:"die PrÃ¼fung",zh:"è€ƒè©¦",cat:"æ•™è‚²",article:"die"},
  {de:"das Fach",zh:"ç§‘ç›®",cat:"æ•™è‚²",article:"das"},
  {de:"die Kenntnisse",zh:"çŸ¥è­˜",cat:"æ•™è‚²",article:"die"},
  {de:"die Forschung",zh:"ç ”ç©¶",cat:"æ•™è‚²",article:"die"},
  {de:"die UniversitÃ¤t",zh:"å¤§å­¸",cat:"æ•™è‚²",article:"die"},
  {de:"das Zeugnis",zh:"æˆç¸¾å–®",cat:"æ•™è‚²",article:"das"},
  {de:"die Beschwerde",zh:"ä¸é©ã€ç—‡ç‹€",cat:"å¥åº·",article:"die"},
  {de:"die Behandlung",zh:"æ²»ç™‚",cat:"å¥åº·",article:"die"},
  {de:"das Rezept",zh:"è™•æ–¹ç®‹",cat:"å¥åº·",article:"das"},
  {de:"die Krankenkasse",zh:"å¥ä¿",cat:"å¥åº·",article:"die"},
  {de:"die Allergie",zh:"éæ•",cat:"å¥åº·",article:"die"},
  {de:"die Operation",zh:"æ‰‹è¡“",cat:"å¥åº·",article:"die"},
  {de:"sich erholen",zh:"æ¢å¾©ã€ä¼‘é¤Š",cat:"å¥åº·",article:""},
  {de:"bewusstlos",zh:"å¤±å»æ„è­˜çš„",cat:"å¥åº·",article:""},
  {de:"verletzt",zh:"å—å‚·çš„",cat:"å¥åº·",article:""},
  {de:"die Gesellschaft",zh:"ç¤¾æœƒ",cat:"ç¤¾æœƒæ”¿æ²»",article:"die"},
  {de:"die Umwelt",zh:"ç’°å¢ƒ",cat:"ç¤¾æœƒæ”¿æ²»",article:"die"},
  {de:"die Demokratie",zh:"æ°‘ä¸»",cat:"ç¤¾æœƒæ”¿æ²»",article:"die"},
  {de:"die Wahl",zh:"é¸èˆ‰",cat:"ç¤¾æœƒæ”¿æ²»",article:"die"},
  {de:"das Recht",zh:"æ¬Šåˆ©ã€æ³•å¾‹",cat:"ç¤¾æœƒæ”¿æ²»",article:"das"},
  {de:"die Verantwortung",zh:"è²¬ä»»",cat:"ç¤¾æœƒæ”¿æ²»",article:"die"},
  {de:"die Gleichberechtigung",zh:"å¹³ç­‰æ¬Š",cat:"ç¤¾æœƒæ”¿æ²»",article:"die"},
  {de:"die Integration",zh:"èåˆ",cat:"ç¤¾æœƒæ”¿æ²»",article:"die"},
  {de:"die Armut",zh:"è²§å›°",cat:"ç¤¾æœƒæ”¿æ²»",article:"die"},
  {de:"die Grenze",zh:"é‚Šç•Œ",cat:"ç¤¾æœƒæ”¿æ²»",article:"die"},
  {de:"die Abfahrt",zh:"å‡ºç™¼",cat:"äº¤é€šæ—…è¡Œ",article:"die"},
  {de:"die Ankunft",zh:"æŠµé”",cat:"äº¤é€šæ—…è¡Œ",article:"die"},
  {de:"der Stau",zh:"å¡è»Š",cat:"äº¤é€šæ—…è¡Œ",article:"der"},
  {de:"die VerspÃ¤tung",zh:"å»¶èª¤",cat:"äº¤é€šæ—…è¡Œ",article:"die"},
  {de:"umsteigen",zh:"è½‰ä¹˜",cat:"äº¤é€šæ—…è¡Œ",article:""},
  {de:"der FÃ¼hrerschein",zh:"é§•ç…§",cat:"äº¤é€šæ—…è¡Œ",article:"der"},
  {de:"die Unterkunft",zh:"ä½å®¿",cat:"äº¤é€šæ—…è¡Œ",article:"die"},
  {de:"der Ausflug",zh:"ä¸€æ—¥éŠ",cat:"äº¤é€šæ—…è¡Œ",article:"der"},
  {de:"der GrenzÃ¼bergang",zh:"é‚Šå¢ƒé€šé“",cat:"äº¤é€šæ—…è¡Œ",article:"der"},
  {de:"die Rechnung",zh:"å¸³å–®",cat:"è³¼ç‰©é‡‘éŒ¢",article:"die"},
  {de:"der Rabatt",zh:"æŠ˜æ‰£",cat:"è³¼ç‰©é‡‘éŒ¢",article:"der"},
  {de:"das Angebot",zh:"ç‰¹åƒ¹ã€ææ¡ˆ",cat:"è³¼ç‰©é‡‘éŒ¢",article:"das"},
  {de:"die Quittung",zh:"æ”¶æ“š",cat:"è³¼ç‰©é‡‘éŒ¢",article:"die"},
  {de:"zurÃ¼ckgeben",zh:"é€€è²¨",cat:"è³¼ç‰©é‡‘éŒ¢",article:""},
  {de:"leihen",zh:"å€Ÿ",cat:"è³¼ç‰©é‡‘éŒ¢",article:""},
  {de:"sparen",zh:"å„²è“„",cat:"è³¼ç‰©é‡‘éŒ¢",article:""},
  {de:"ausgeben",zh:"èŠ±è²»",cat:"è³¼ç‰©é‡‘éŒ¢",article:""},
  {de:"die Versicherung",zh:"ä¿éšª",cat:"è³¼ç‰©é‡‘éŒ¢",article:"die"},
  {de:"der Sturm",zh:"æš´é¢¨",cat:"å¤©æ°£è‡ªç„¶",article:"der"},
  {de:"die Ãœberschwemmung",zh:"æ´ªæ°´",cat:"å¤©æ°£è‡ªç„¶",article:"die"},
  {de:"die DÃ¼rre",zh:"ä¹¾æ—±",cat:"å¤©æ°£è‡ªç„¶",article:"die"},
  {de:"das Klima",zh:"æ°£å€™",cat:"å¤©æ°£è‡ªç„¶",article:"das"},
  {de:"die Umweltverschmutzung",zh:"ç’°å¢ƒæ±¡æŸ“",cat:"å¤©æ°£è‡ªç„¶",article:"die"},
  {de:"nachhaltig",zh:"æ°¸çºŒçš„",cat:"å¤©æ°£è‡ªç„¶",article:""},
  {de:"sich kÃ¼mmern um",zh:"ç…§é¡§ã€é—œå¿ƒ",cat:"å¸¸ç”¨å‹•è©",article:""},
  {de:"sich bewerben",zh:"ç”³è«‹",cat:"å¸¸ç”¨å‹•è©",article:""},
  {de:"sich entscheiden",zh:"æ±ºå®š",cat:"å¸¸ç”¨å‹•è©",article:""},
  {de:"sich vorstellen",zh:"æƒ³åƒã€è‡ªæˆ‘ä»‹ç´¹",cat:"å¸¸ç”¨å‹•è©",article:""},
  {de:"stattfinden",zh:"èˆ‰è¡Œã€ç™¼ç”Ÿ",cat:"å¸¸ç”¨å‹•è©",article:""},
  {de:"ausfÃ¼llen",zh:"å¡«å¯«",cat:"å¸¸ç”¨å‹•è©",article:""},
  {de:"beantragen",zh:"ç”³è«‹ï¼ˆå®˜æ–¹ï¼‰",cat:"å¸¸ç”¨å‹•è©",article:""},
  {de:"vereinbaren",zh:"ç´„å®š",cat:"å¸¸ç”¨å‹•è©",article:""},
  {de:"vergleichen",zh:"æ¯”è¼ƒ",cat:"å¸¸ç”¨å‹•è©",article:""},
  {de:"Ã¼berweisen",zh:"è½‰å¸³",cat:"å¸¸ç”¨å‹•è©",article:""},
  {de:"einschrÃ¤nken",zh:"é™åˆ¶",cat:"å¸¸ç”¨å‹•è©",article:""},
  {de:"ausreichend",zh:"è¶³å¤ çš„",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"geeignet",zh:"åˆé©çš„",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"gÃ¼ltig",zh:"æœ‰æ•ˆçš„",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"erforderlich",zh:"å¿…è¦çš„",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"freiwillig",zh:"è‡ªé¡˜çš„",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"Ã¶ffentlich",zh:"å…¬é–‹çš„ã€å…¬å…±çš„",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"beruflich",zh:"è·æ¥­ä¸Šçš„",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"persÃ¶nlich",zh:"å€‹äººçš„",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"schriftlich",zh:"æ›¸é¢çš„",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"mÃ¼ndlich",zh:"å£é ­çš„",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"plÃ¶tzlich",zh:"çªç„¶åœ°",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"kaum",zh:"å¹¾ä¹ä¸",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"trotzdem",zh:"å„˜ç®¡å¦‚æ­¤",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"auÃŸerdem",zh:"æ­¤å¤–",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"daher",zh:"å› æ­¤",cat:"å½¢å®¹è©å‰¯è©",article:""},
  {de:"allerdings",zh:"ä¸éã€ç¢ºå¯¦",cat:"å½¢å®¹è©å‰¯è©",article:""},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE STORAGE â€” é›²ç«¯åŒæ­¥ï¼Œè·¨è£ç½®å³æ™‚åŒæ­¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let cloudData = {
    words: [], favorites: [], learned: [], notes: {},
    quizCorrect: 0, quizTotal: 0, lastVisit: '', notificationEnabled: false,
};
let syncTimeout = null;
let currentUid = null;

// å¾ Firestore è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
async function loadFromCloud() {
    if (!currentUid) return;
    try {
        const ref = window._doc(window._db, 'users', currentUid);
        const snap = await window._getDoc(ref);
        if (snap.exists()) {
            cloudData = { ...cloudData, ...snap.data() };
        }
    } catch (e) {
        console.warn('Firestore load:', e.message);
        setSyncStatus('error', 'è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬æ©Ÿå‚™ä»½');
    }
}

// é˜²æŠ–å„²å­˜ï¼ˆ1.2 ç§’å¾Œå¯«å…¥ Firestoreï¼‰
function scheduleCloudSave() {
    setSyncStatus('syncing', 'åŒæ­¥ä¸­â€¦');
    clearTimeout(syncTimeout);
    syncTimeout = setTimeout(saveToCloud, 1200);
}

async function saveToCloud() {
    if (!currentUid) return;
    try {
        const ref = window._doc(window._db, 'users', currentUid);
        await window._setDoc(ref, cloudData);
        setSyncStatus('ok', 'âœ“ å·²åŒæ­¥');
    } catch (e) {
        setSyncStatus('error', 'åŒæ­¥å¤±æ•—');
        console.error('Firestore save:', e);
    }
}

function setSyncStatus(type, msg) {
    const bar = document.getElementById('sync-bar');
    if (!bar) return;
    bar.className = 'sync-bar' + (type !== 'ok' ? ' ' + type : '');
    const el = document.getElementById('sync-text');
    if (el) el.textContent = msg;
}

// â”€â”€ Google ç™»å…¥ / ç™»å‡º â”€â”€
async function signInWithGoogle() {
    try {
        await window._signInWithPopup(window._auth, window._provider);
        // onAuthStateChanged æœƒè‡ªå‹•è§¸ç™¼ onUserSignedIn
    } catch (e) {
        alert('ç™»å…¥å¤±æ•—ï¼š' + (e.message || e));
    }
}

async function doSignOut() {
    if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) return;
    await window._signOut(window._auth);
}

// ç™»å…¥æˆåŠŸ callbackï¼ˆç”± Firebase onAuthStateChanged å‘¼å«ï¼‰
window.onUserSignedIn = async function(user) {
    currentUid = user.uid;

    // é¡¯ç¤ºè¼‰å…¥ç•«é¢
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('loading-screen').style.display = 'flex';
    document.getElementById('loading-screen').style.alignItems = 'center';
    document.getElementById('loading-screen').style.justifyContent = 'center';
    document.getElementById('loading-screen').style.position = 'fixed';
    document.getElementById('loading-screen').style.inset = '0';
    document.getElementById('loading-screen').style.background = 'linear-gradient(135deg,#c89f7e,#8b7355)';

    await loadFromCloud();

    // é¡¯ç¤ºä¸»ç•«é¢
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';

    // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
    document.getElementById('user-name').textContent = user.displayName || 'å­¸ç¿’è€…';
    document.getElementById('user-email').textContent = user.email || '';
    const avatarWrap = document.getElementById('user-avatar-wrap');
    if (user.photoURL) {
        avatarWrap.innerHTML = `<img class="user-avatar" src="${user.photoURL}" referrerpolicy="no-referrer">`;
    } else {
        const initial = (user.displayName || 'U')[0].toUpperCase();
        avatarWrap.innerHTML = `<div class="user-avatar-placeholder">${initial}</div>`;
    }

    setSyncStatus('ok', 'âœ“ å·²åŒæ­¥');
    updateFlashPool(); updateStats(); renderFlash();
    checkDailyReminder(); updateNotificationButton();
};

window.onUserSignedOut = function() {
    currentUid = null;
    document.getElementById('main-app').style.display = 'none';
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
};

// â”€â”€ å‚™ä»½åŒ¯å‡ºï¼ˆä¿ç•™åŠŸèƒ½ï¼‰ â”€â”€
function exportBackup() {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(cloudData, null, 2)], {type:'application/json'}));
    a.download = `å¾·æ–‡å–®å­—æœ¬å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
    a.style.display='none'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    showToast('âœ… å‚™ä»½å·²ä¸‹è¼‰ï¼');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP STATE (in-memory, sourced from cloudData)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFavSet() { return new Set(cloudData.favorites); }
function getLearnedSet() { return new Set(cloudData.learned); }

let currentTab = 'flash';
let b1Cat = 'å…¨éƒ¨';
let flashIndex = 0;
let isFlipped = false;
let flashPool = [];
let currentFilter = 'å…¨éƒ¨';
let quizWords = [], quizIdx = 0, quizSessionCorrect = 0, quizAnswered = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT â€” ç”± Firebase onAuthStateChanged è§¸ç™¼
//  ä¸éœ€è¦æ‰‹å‹• init()ï¼Œç™»å…¥å¾Œè‡ªå‹•åŸ·è¡Œ onUserSignedIn
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getActivePool() {
    const myMapped = cloudData.words.map(w => ({
        de: w.german, zh: w.chinese, cat: 'â­ æˆ‘çš„å–®å­—', article: '', _my: true
    }));
    const all = [...B1_VOCAB, ...myMapped];
    if (b1Cat === 'å…¨éƒ¨') return all;
    return all.filter(v => v.cat === b1Cat);
}

function updateFlashPool() {
    flashPool = getActivePool();
    if (flashIndex >= flashPool.length) flashIndex = 0;
}

function updateStats() {
    const learned = getLearnedSet();
    const favs = getFavSet();
    document.getElementById('s-total').textContent = B1_VOCAB.length + cloudData.words.length;
    document.getElementById('s-learned').textContent = learned.size;
    document.getElementById('s-fav').textContent = favs.size;
    const acc = cloudData.quizTotal > 0 ? Math.round(cloudData.quizCorrect / cloudData.quizTotal * 100) : 0;
    document.getElementById('s-acc').textContent = acc + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
    currentTab = tab;
    ['flash','quiz','fav','mywords'].forEach(t => {
        document.getElementById('view-'+t).style.display = t===tab ? 'block' : 'none';
    });
    document.querySelectorAll('.main-tab').forEach((b,i) => {
        b.classList.toggle('active', ['flash','quiz','fav','mywords'][i] === tab);
    });
    // dropdown only shows for flash/quiz
    document.getElementById('cat-dropdown-row').style.display = ['flash','quiz'].includes(tab) ? 'flex' : 'none';
    document.getElementById('notif-bar').style.display = tab==='mywords' ? 'flex' : 'none';
    if (tab==='quiz') { document.getElementById('quiz-done').style.display='none'; document.getElementById('quiz-play').style.display='block'; startQuiz(); }
    if (tab==='fav') renderFav();
    if (tab==='mywords') { renderWords(); updateStats(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  B1 CATEGORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectB1Cat(cat) {
    b1Cat = cat; flashIndex = 0;
    const sel = document.getElementById('cat-select');
    if (sel && sel.value !== cat) sel.value = cat;
    updateFlashPool();
    if (currentTab==='flash') renderFlash();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLASHCARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFlash() {
    if (!flashPool.length) return;
    const w = flashPool[flashIndex];
    const favs = getFavSet();
    isFlipped = false;
    document.getElementById('flashcard').classList.remove('flipped');
    document.getElementById('c-de').textContent = w.de;
    document.getElementById('c-article').textContent = w.article ? `ã€${w.article}ã€‘` : '';
    document.getElementById('c-cat').textContent = w.cat;
    document.getElementById('c-zh').textContent = w.zh;
    document.getElementById('c-source').textContent = w._my ? 'â­ æˆ‘çš„å–®å­—' : `ğŸ“‚ ${w.cat}`;
    document.getElementById('fav-btn').textContent = favs.has(w.de) ? 'â¤ï¸' : 'ğŸ¤';
    document.getElementById('flash-counter').textContent = `${flashIndex+1} / ${flashPool.length}`;
    document.getElementById('fp-fill').style.width = ((flashIndex+1)/flashPool.length*100)+'%';
    document.getElementById('btn-prev').disabled = flashIndex===0;
    document.getElementById('btn-next').disabled = flashIndex===flashPool.length-1;

    // é¡¯ç¤ºå€‹äººç­†è¨˜ï¼ˆèƒŒé¢ï¼‰
    const noteKey = 'note:' + w.de;
    const exKey   = 'ex:'   + w.de;
    const noteVal = cloudData.notes && cloudData.notes[noteKey];
    const exVal   = cloudData.notes && cloudData.notes[exKey];

    const noteEl   = document.getElementById('c-note');
    const noteExEl = document.getElementById('c-note-ex');
    const noteDot  = document.getElementById('note-dot');

    if (noteVal) {
        noteEl.textContent = 'ğŸ“ ' + noteVal;
        noteEl.style.display = 'block';
    } else {
        noteEl.style.display = 'none';
    }
    if (exVal) {
        noteExEl.textContent = 'ğŸ’¬ ' + exVal;
        noteExEl.style.display = 'block';
    } else {
        noteExEl.style.display = 'none';
    }
    noteDot.style.display = (noteVal || exVal) ? 'block' : 'none';

    // Mark learned
    const learnedSet = getLearnedSet();
    if (!learnedSet.has(w.de)) {
        learnedSet.add(w.de);
        cloudData.learned = [...learnedSet];
        scheduleCloudSave();
        updateStats();
    }
}

function flipCard() {
    isFlipped = !isFlipped;
    document.getElementById('flashcard').classList.toggle('flipped', isFlipped);
}
function nextCard() { if (flashIndex < flashPool.length-1) { flashIndex++; renderFlash(); } }
function prevCard() { if (flashIndex > 0) { flashIndex--; renderFlash(); } }
function shuffleCards() { flashPool.sort(()=>Math.random()-0.5); flashIndex=0; renderFlash(); showToast('ğŸ”€ å·²éš¨æ©Ÿæ’åˆ—ï¼'); }

function toggleFav() {
    const w = flashPool[flashIndex];
    if (!w) return;
    const btn = document.getElementById('fav-btn');
    const favs = getFavSet();
    if (favs.has(w.de)) {
        favs.delete(w.de);
        btn.textContent = 'ğŸ¤';
        showToast('å·²ç§»é™¤æ”¶è—');
    } else {
        favs.add(w.de);
        btn.textContent = 'â¤ï¸';
        btn.classList.add('pop');
        setTimeout(()=>btn.classList.remove('pop'),300);
        showToast('â¤ï¸ å·²åŠ å…¥æ”¶è—ï¼');
    }
    cloudData.favorites = [...favs];
    scheduleCloudSave();
    updateStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentNoteWord = null;

function openNoteModal() {
    const w = flashPool[flashIndex];
    if (!w) return;
    currentNoteWord = w;
    if (!cloudData.notes) cloudData.notes = {};
    document.getElementById('modal-word').textContent = w.de;
    document.getElementById('modal-zh').textContent = w.zh;
    document.getElementById('modal-note').value    = cloudData.notes['note:' + w.de] || '';
    document.getElementById('modal-example').value = cloudData.notes['ex:'   + w.de] || '';
    document.getElementById('note-modal').classList.add('show');
    setTimeout(() => document.getElementById('modal-note').focus(), 200);
}

function closeNoteModal(e) {
    if (e && e.target !== document.getElementById('note-modal')) return;
    document.getElementById('note-modal').classList.remove('show');
    currentNoteWord = null;
}

function saveNote() {
    if (!currentNoteWord) return;
    if (!cloudData.notes) cloudData.notes = {};
    const n = document.getElementById('modal-note').value.trim();
    const x = document.getElementById('modal-example').value.trim();
    const nk = 'note:' + currentNoteWord.de;
    const xk = 'ex:'   + currentNoteWord.de;
    if (n) cloudData.notes[nk] = n; else delete cloudData.notes[nk];
    if (x) cloudData.notes[xk] = x; else delete cloudData.notes[xk];
    scheduleCloudSave();
    document.getElementById('note-modal').classList.remove('show');
    renderFlash();
    showToast('âœ… ç­†è¨˜å·²å„²å­˜ï¼');
    currentNoteWord = null;
}

function clearNote() {
    document.getElementById('modal-note').value = '';
    document.getElementById('modal-example').value = '';
}

// Close modal on Escape
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') document.getElementById('note-modal').classList.remove('show');
});

function openNoteModalForWord(de, zh) {
    if (!cloudData.notes) cloudData.notes = {};
    currentNoteWord = { de, zh };
    document.getElementById('modal-word').textContent = de;
    document.getElementById('modal-zh').textContent = zh;
    document.getElementById('modal-note').value    = cloudData.notes['note:' + de] || '';
    document.getElementById('modal-example').value = cloudData.notes['ex:'   + de] || '';
    document.getElementById('note-modal').classList.add('show');
    setTimeout(() => document.getElementById('modal-note').focus(), 200);
}

function startQuiz() {
    const pool = getActivePool();
    const use = pool.length >= 4 ? pool : [...B1_VOCAB];
    quizWords = [...use].sort(()=>Math.random()-0.5).slice(0,Math.min(15,use.length));
    quizIdx=0; quizSessionCorrect=0;
    document.getElementById('quiz-play').style.display='block';
    document.getElementById('quiz-done').style.display='none';
    renderQuizQ();
}

function renderQuizQ() {
    const q = quizWords[quizIdx];
    document.getElementById('q-word').textContent = q.de;
    document.getElementById('q-score').textContent = `âœ… ${quizSessionCorrect} / ${quizIdx}`;
    document.getElementById('q-prog').textContent = `ç¬¬ ${quizIdx+1} / ${quizWords.length} é¡Œ`;
    quizAnswered = false;

    const allPool = [...B1_VOCAB, ...cloudData.words.map(w=>({de:w.german,zh:w.chinese}))];
    const wrongs = allPool.filter(v=>v.zh!==q.zh).sort(()=>Math.random()-0.5).slice(0,3);
    const opts = [q,...wrongs].sort(()=>Math.random()-0.5);

    document.getElementById('q-opts').innerHTML = opts.map(o =>
        `<button class="quiz-opt" onclick="answerQuiz(this,${JSON.stringify(o.zh)},${JSON.stringify(q.zh)})">${o.zh}</button>`
    ).join('');
}

function answerQuiz(btn, chosen, correct) {
    if (quizAnswered) return;
    quizAnswered = true;
    document.querySelectorAll('.quiz-opt').forEach(b=>b.disabled=true);
    if (chosen===correct) {
        btn.classList.add('correct'); quizSessionCorrect++; cloudData.quizCorrect++; showToast('âœ… æ­£ç¢ºï¼');
    } else {
        btn.classList.add('wrong');
        document.querySelectorAll('.quiz-opt').forEach(b=>{ if(b.textContent===correct) b.classList.add('correct'); });
        showToast('âŒ ç­”éŒ¯äº†');
    }
    cloudData.quizTotal++;
    quizIdx++;
    scheduleCloudSave();
    updateStats();
    setTimeout(()=>{ if(quizIdx>=quizWords.length) showQuizDone(); else renderQuizQ(); }, 1100);
}

function showQuizDone() {
    document.getElementById('quiz-play').style.display='none';
    document.getElementById('quiz-done').style.display='block';
    const pct = Math.round(quizSessionCorrect/quizWords.length*100);
    document.getElementById('qr-pct').textContent = pct+'%';
    const tiers = [[90,'ğŸ† å¤ªæ£’äº†ï¼','B1 å¯¦åŠ›å¾ˆå¼·ï¼ç¹¼çºŒä¿æŒ'],[70,'ğŸ‰ ä¸éŒ¯å–”ï¼','å¿«è¦å®Œå…¨æŒæ¡äº†ï¼'],[50,'ğŸ“š åŠ æ²¹ï¼','å¤šç¿»å¹¾æ¬¡ç¿»å¡å¡ç‰‡'],[0,'ğŸ’ª ç¹¼çºŒç·´ç¿’ï¼','ç†Ÿèƒ½ç”Ÿå·§ï¼Œä¸æ”¾æ£„ï¼']];
    const [,msg,sub] = tiers.find(([t])=>pct>=t);
    document.getElementById('qr-msg').textContent = msg;
    document.getElementById('qr-sub').textContent = `ç­”å° ${quizSessionCorrect} / ${quizWords.length} é¡Œ â€” ${sub}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FAVORITES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFav() {
    const favs = getFavSet();
    const allPool = [...B1_VOCAB, ...cloudData.words.map(w=>({de:w.german,zh:w.chinese,cat:'â­ æˆ‘çš„å–®å­—'}))];
    const favList = allPool.filter(v=>favs.has(v.de));
    const el = document.getElementById('fav-content');
    if (!favList.length) {
        el.innerHTML='<div class="empty-state"><div class="big">ğŸ¤</div><p>é‚„æ²’æœ‰æ”¶è—<br>åœ¨ç¿»å¡æ¨¡å¼é» ğŸ¤ åŠ å…¥æ”¶è—</p></div>'; return;
    }
    el.innerHTML = `<div class="fav-grid">${favList.map(w=>`
        <div class="fav-card">
            <div>
                <div class="fav-de">${w.de}</div>
                <div class="fav-zh">${w.zh}</div>
                <span class="fav-tag">${w.cat}</span>
            </div>
            <button class="unfav-btn" onclick="removeFav(${JSON.stringify(w.de)})">â¤ï¸</button>
        </div>`).join('')}</div>`;
}

function removeFav(de) {
    const favs = getFavSet(); favs.delete(de);
    cloudData.favorites = [...favs];
    scheduleCloudSave(); updateStats(); renderFav(); showToast('å·²ç§»é™¤æ”¶è—');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MY WORDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addWord() {
    const german = document.getElementById('germanInput').value.trim();
    const chinese = document.getElementById('chineseInput').value.trim();
    const sentence = document.getElementById('sentenceInput').value.trim();
    const category = document.getElementById('categoryInput').value;
    if (!german||!chinese) { showToast('è«‹å¡«å¯«å¾·æ–‡å–®å­—å’Œä¸­æ–‡æ„æ€ï¼'); return; }
    cloudData.words.push({ german, chinese, sentence, category, addedDate: new Date().toISOString() });
    scheduleCloudSave();
    document.getElementById('germanInput').value='';
    document.getElementById('chineseInput').value='';
    document.getElementById('sentenceInput').value='';
    renderWords(); updateStats(); updateFlashPool();
    showToast('âœ… æ–°å¢æˆåŠŸï¼å·²å„²å­˜è‡³ç€è¦½å™¨');
}

function deleteWord(index) {
    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å–®å­—å—ï¼Ÿ')) {
        cloudData.words.splice(index,1);
        scheduleCloudSave(); renderWords(); updateStats(); updateFlashPool();
    }
}

function filterWords(category, event) {
    currentFilter=category; renderWords();
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    if (event&&event.target) event.target.classList.add('active');
}

function renderWords() {
    const list = document.getElementById('wordList');
    const filtered = currentFilter==='å…¨éƒ¨' ? cloudData.words : cloudData.words.filter(w=>w.category===currentFilter);
    if (!filtered.length) {
        list.innerHTML='<p style="text-align:center;color:#bbb;padding:20px;">æ²’æœ‰å–®å­—</p>';
        document.getElementById('totalWords').textContent = cloudData.words.length; return;
    }
    if (!cloudData.notes) cloudData.notes = {};
    list.innerHTML = filtered.map(word => {
        const actualIndex = cloudData.words.indexOf(word);
        const noteVal = cloudData.notes['note:' + word.german] || '';
        const exVal   = cloudData.notes['ex:'   + word.german] || '';
        return `<div class="word-item">
            <div class="word-content">
                <div class="german">${word.german}</div>
                <div class="chinese">${word.chinese}</div>
                ${word.sentence ? `<div class="sentence">ğŸ’¬ ${word.sentence}</div>` : ''}
                ${noteVal ? `<div class="word-note">ğŸ“ ${noteVal}</div>` : ''}
                ${exVal   ? `<div class="word-note-ex">âœï¸ ${exVal}</div>` : ''}
                <span class="category">${word.category||'å…¶ä»–'}</span>
            </div>
          
<div class="word-item-btns">
  <button class="edit-btn" onclick="openNoteModalForWord(${JSON.stringify(word.german)}, ${JSON.stringify(word.chinese)})">âœï¸ ç­†è¨˜</button>
  <button class="edit-btn" onclick="openEditWordModal(${actualIndex})">ğŸ›  ç·¨è¼¯</button>
  <button class="delete-btn" onclick="deleteWord(${actualIndex})">åˆªé™¤</button>
</div>
        </div>`;
    }).join('');
    document.getElementById('totalWords').textContent = cloudData.words.length;
}
// ====== ç·¨è¼¯æˆ‘çš„å–®å­—ï¼ˆæ–°å¢ï¼‰ ======
let currentEditIndex = null;

function openEditWordModal(index) {
  currentEditIndex = index;
  const w = cloudData.words[index];
  if (!w) return;

  // é å¡«å…§å®¹
  document.getElementById('edit-de').value = w.german || '';
  document.getElementById('edit-zh').value = w.chinese || '';
  document.getElementById('edit-sentence').value = w.sentence || '';
  document.getElementById('edit-category').value = w.category || 'å…¶ä»–';

  document.getElementById('edit-word-modal').classList.add('show');
  setTimeout(() => document.getElementById('edit-de').focus(), 150);
}

function closeEditWordModal(e) {
  if (e && e.target !== document.getElementById('edit-word-modal')) return;
  document.getElementById('edit-word-modal').classList.remove('show');
  currentEditIndex = null;
}

function saveEditedWord() {
  if (currentEditIndex === null) return;

  // å–å€¼èˆ‡æª¢æŸ¥
  const newDe = document.getElementById('edit-de').value.trim();
  const newZh = document.getElementById('edit-zh').value.trim();
  const newSentence = document.getElementById('edit-sentence').value.trim();
  const newCat = document.getElementById('edit-category').value;

  if (!newDe || !newZh) {
    showToast('è«‹å¡«å¯«å¾·æ–‡èˆ‡ä¸­æ–‡');
    return;
  }

  const w = cloudData.words[currentEditIndex];
  if (!w) return;

  const oldDe = w.german;

  // å¯«å› words
  w.german = newDe;
  w.chinese = newZh;
  w.sentence = newSentence;
  w.category = newCat;

  // è‹¥å¾·æ–‡å­—ä¸²æœ‰æ”¹ï¼Œéœ€åŒæ­¥è™•ç†ã€Œæ”¶è—ã€å·²è¤‡ç¿’ã€ç­†è¨˜éµåã€
  if (oldDe !== newDe) {
    renameMyWordSideEffects(oldDe, newDe);
  }

  scheduleCloudSave();
  closeEditWordModal();
  renderWords();
  updateStats();
  updateFlashPool();
  // è‹¥ç›®å‰ç¿»å¡åœåœ¨æˆ‘çš„å–®å­—ï¼Œé‡æ–°æ¸²æŸ“ä¸€ä¸‹é¿å…é¡¯ç¤ºèˆŠå­—
  try { renderFlash(); } catch (_) {}

  showToast('âœ… å·²æ›´æ–°');
}

// è®Šæ›´ key ç›¸é—œçš„é—œè¯ï¼ˆæ”¶è—ã€å·²è¤‡ç¿’ã€ç­†è¨˜ï¼‰
function renameMyWordSideEffects(oldDe, newDe) {
  // 1) æ”¶è— favorites: æ˜¯ä¸€å€‹å­—ä¸²é™£åˆ—
  const favSet = new Set(cloudData.favorites || []);
  if (favSet.has(oldDe)) {
    favSet.delete(oldDe);
    favSet.add(newDe);
    cloudData.favorites = [...favSet];
  }

  // 2) å·²è¤‡ç¿’ learned: ä¹Ÿæ˜¯å­—ä¸²é™£åˆ—
  const learnedSet = new Set(cloudData.learned || []);
  if (learnedSet.has(oldDe)) {
    learnedSet.delete(oldDe);
    learnedSet.add(newDe);
    cloudData.learned = [...learnedSet];
  }

  // 3) ç­†è¨˜ notes: key ç‚º "note:<de>" èˆ‡ "ex:<de>"
  if (!cloudData.notes) cloudData.notes = {};
  const oldNoteKey = 'note:' + oldDe;
  const oldExKey = 'ex:' + oldDe;
  const newNoteKey = 'note:' + newDe;
  const newExKey = 'ex:' + newDe;

  if (cloudData.notes[oldNoteKey] && !cloudData.notes[newNoteKey]) {
    cloudData.notes[newNoteKey] = cloudData.notes[oldNoteKey];
  }
  if (cloudData.notes[oldExKey] && !cloudData.notes[newExKey]) {
    cloudData.notes[newExKey] = cloudData.notes[oldExKey];
  }
  delete cloudData.notes[oldNoteKey];
  delete cloudData.notes[oldExKey];
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTIFICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkDailyReminder() {
    const today = new Date().toDateString();
    const total = B1_VOCAB.length + cloudData.words.length;
    if (cloudData.lastVisit !== today && total > 0) {
        document.getElementById('reminderBox').style.display='block';
        document.getElementById('todayCount').textContent=total;
    }
    cloudData.lastVisit = today;
    scheduleCloudSave();
}

async function toggleNotification() {
    if (!cloudData.notificationEnabled) {
        if ('Notification' in window) {
            const p = await Notification.requestPermission();
            if (p==='granted') {
                cloudData.notificationEnabled=true; scheduleCloudSave(); scheduleDailyNotification();
                alert('âœ… é€šçŸ¥å·²å•Ÿç”¨ï¼æˆ‘æœƒåœ¨æ¯å¤©æ—©ä¸Š 9 é»æé†’ä½ è¤‡ç¿’å–®å­—');
            } else { alert('âŒ éœ€è¦é€šçŸ¥æ¬Šé™æ‰èƒ½æé†’ä½ å–”ï¼'); }
        } else { alert('âŒ ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥åŠŸèƒ½'); }
    } else {
        cloudData.notificationEnabled=false; scheduleCloudSave(); alert('ğŸ”• å·²é—œé–‰æ¯æ—¥æé†’');
    }
    updateNotificationButton();
}

function updateNotificationButton() {
    const btn = document.getElementById('notificationBtn');
    btn.textContent = cloudData.notificationEnabled ? 'ğŸ”” å·²å•Ÿç”¨' : 'ğŸ”• å•Ÿç”¨é€šçŸ¥';
    btn.style.background = cloudData.notificationEnabled ? '#7d9d65' : '#a0826d';
}

function scheduleDailyNotification() {
    if (cloudData.notificationEnabled && 'Notification' in window && Notification.permission==='granted') {
        const now=new Date(), tmr=new Date(now);
        tmr.setDate(tmr.getDate()+1); tmr.setHours(9,0,0,0);
        setTimeout(()=>{
            new Notification('ğŸ“š è©²è¤‡ç¿’å¾·æ–‡å–®å­—äº†ï¼',{body:`ä½ æœ‰ ${B1_VOCAB.length+cloudData.words.length} å€‹å–®å­—ç­‰è‘—ä½ è¤‡ç¿’å‘¢ï¼`});
            scheduleDailyNotification();
        }, tmr-now);
    }
}
if (cloudData.notificationEnabled) scheduleDailyNotification();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportToPDF() {
    if (!cloudData.words.length) { alert('é‚„æ²’æœ‰è‡ªè¨‚å–®å­—å–”ï¼'); return; }
    let content = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>æˆ‘çš„å¾·æ–‡å–®å­—æœ¬</title>
    <style>body{font-family:Arial,sans-serif;padding:20px}h1{color:#8b6f47}.word{margin-bottom:20px;padding:15px;border:2px solid #d4a574;border-radius:8px;page-break-inside:avoid}.german{font-size:20px;font-weight:bold;color:#8b6f47}.chinese{font-size:16px;color:#666;margin-top:5px}.sentence{font-style:italic;color:#8b6f47;margin-top:5px}.category{display:inline-block;background:#d4a574;color:white;padding:3px 10px;border-radius:12px;font-size:12px;margin-top:5px}</style>
    </head><body><h1>ğŸ“š æˆ‘çš„å¾·æ–‡å–®å­—æœ¬</h1><p>å…± ${cloudData.words.length} å€‹å–®å­— Â· åŒ¯å‡ºæ—¥æœŸï¼š${new Date().toLocaleDateString('zh-TW')}</p><hr>`;
    cloudData.words.forEach((w,i)=>{
        content+=`<div class="word"><div class="german">${i+1}. ${w.german}</div><div class="chinese">${w.chinese}</div>${w.sentence?`<div class="sentence">ğŸ’¬ ${w.sentence}</div>`:''}<span class="category">${w.category||'å…¶ä»–'}</span></div>`;
    });
    content+=`</body></html>`;
    const pw=window.open('','_blank'); pw.document.write(content); pw.document.close();
    pw.onload=()=>pw.print();
}

function exportToExcel() {
    if (!cloudData.words.length) { alert('é‚„æ²’æœ‰è‡ªè¨‚å–®å­—å–”ï¼'); return; }
    let csv='\uFEFFå¾·æ–‡å–®å­—,ä¸­æ–‡æ„æ€,ä¾‹å¥,åˆ†é¡,æ–°å¢æ—¥æœŸ\n';
    cloudData.words.forEach(w=>{
        const s=w.sentence?w.sentence.replace(/,/g,'ï¼Œ'):'';
        const d=new Date(w.addedDate).toLocaleDateString('zh-TW');
        csv+=`"${w.german}","${w.chinese}","${s}","${w.category||'å…¶ä»–'}","${d}"\n`;
    });
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=`å¾·æ–‡å–®å­—æœ¬_${new Date().toISOString().split('T')[0]}.csv`;
    a.style.display='none'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg) {
    const t=document.getElementById('toast');
    t.textContent=msg; t.classList.add('show');
    clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),2200);
}

document.addEventListener('keydown', e=>{
    if (currentTab!=='flash') return;
    if (e.code==='Space') { e.preventDefault(); flipCard(); }
    if (e.code==='ArrowRight') nextCard();
    if (e.code==='ArrowLeft') prevCard();
    if (e.code==='KeyF') toggleFav();
});

document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('germanInput').addEventListener('keypress',e=>{ if(e.key==='Enter') document.getElementById('chineseInput').focus(); });
    document.getElementById('chineseInput').addEventListener('keypress',e=>{ if(e.key==='Enter') document.getElementById('sentenceInput').focus(); });
    document.getElementById('sentenceInput').addEventListener('keypress',e=>{ if(e.key==='Enter'){ addWord(); document.getElementById('germanInput').focus(); }});
});

// Firebase onAuthStateChanged è‡ªå‹•è§¸ç™¼å•Ÿå‹•ï¼Œä¸éœ€è¦æ‰‹å‹• init()
</script>
</body>
</html>
